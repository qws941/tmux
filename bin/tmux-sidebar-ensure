#!/usr/bin/env bash
# tmux-sidebar-ensure â€” ensure sidebar exists in current window
# Called by window-linked hook

set -euo pipefail

SIDEBAR_WIDTH=${SIDEBAR_WIDTH:-20}
SIDEBAR_SCRIPT="${HOME}/.tmux/bin/tmux-sidebar"

# Already has sidebar?
if tmux list-panes -F '#{pane_title}' 2>/dev/null | grep -q '^sidebar$'; then
    exit 0
fi

# Skip if terminal too narrow
client_width=$(tmux display-message -p '#{client_width}' 2>/dev/null || echo 120)
[[ $client_width -lt 55 ]] && exit 0

# Responsive width
if [[ $client_width -lt 100 ]]; then
    SIDEBAR_WIDTH=12
fi

# Create sidebar
first_pane=$(tmux list-panes -F '#{pane_id}' 2>/dev/null | head -1)
[[ -z "$first_pane" ]] && exit 0

tmux split-window -hb -t "$first_pane" -l "$SIDEBAR_WIDTH" \
    "exec $SIDEBAR_SCRIPT"
tmux select-pane -T sidebar
tmux select-pane -R
