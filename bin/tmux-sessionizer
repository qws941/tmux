#!/usr/bin/env bash
# tmux-sessionizer â€” taskbar-style session switcher + creation wizard
# Usage: tmux-sessionizer [directory]

set -euo pipefail

export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAYOUT_DIR="${SCRIPT_DIR}/../layouts"

# Adaptive layout for narrow screens (Galaxy Fold ~60 cols)
_term_width="${COLUMNS:-$(tput cols 2>/dev/null || echo 80)}"
if [[ "$_term_width" -lt 60 ]]; then
  _preview_pos="bottom:40%"
else
  _preview_pos="right:60%"
fi

# Common fzf colors (Tokyo Night)
_fzf_colors="bg+:#292e42,fg:#a9b1d6,fg+:#c0caf5,hl:#bb9af7,hl+:#bb9af7,info:#7aa2f7,prompt:#7dcfff,pointer:#bb9af7,marker:#9ece6a,header:#565f89"

SCAN_DIR="${HOME}/dev"
EXTRA_DIRS=("${HOME}/.config/opencode")

if [[ -f "${HOME}/.tmux/sessionizer.conf" ]]; then
  # shellcheck source=/dev/null
  source "${HOME}/.tmux/sessionizer.conf"
fi

for cmd in fzf tmux; do
  command -v "${cmd}" &>/dev/null || { echo "error: ${cmd} not found" >&2; exit 1; }
done

# Save original session for cancel/restore
_orig_session=$(tmux display-message -p '#{session_name}' 2>/dev/null || true)

# â”€â”€â”€ Session Creation Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
create_session_wizard() {
  local sel_dir sel_layout sel_name

  # Step 1: Pick directory
  local dirs=""
  while IFS= read -r dir; do
    dirs+="${dir}"$'\n'
  done < <(find "${SCAN_DIR}" -mindepth 1 -maxdepth 1 -type d | sort)
  for dir in "${EXTRA_DIRS[@]}"; do
    [[ -d "$dir" ]] && dirs+="${dir}"$'\n'
  done

  sel_dir=$(
    printf '%s' "${dirs}" \
      | fzf --prompt="  1/3 directory > " \
             --layout=reverse --border=none --no-separator \
             --color="${_fzf_colors}" \
             --header="1/3 directory â”‚ ESC cancel" \
             --preview='
               echo -e "\033[1;34mğŸ“ $(basename {})\033[0m"
               echo -e "\033[90m$(printf "%.0sâ”€" {1..40})\033[0m"
               ls -1 --color=always {} 2>/dev/null | head -25
             ' --preview-window="${_preview_pos}"
  ) || return 1

  local default_name
  default_name=$(basename "${sel_dir}" | tr ' .:' '_')

  # Step 2: Pick layout
  local layouts=""
  layouts+="(auto) auto-detect"$'\n'
  while IFS= read -r yml; do
    local lname
    lname=$(basename "${yml}" .yml)
    layouts+="${lname}"$'\n'
  done < <(find "${LAYOUT_DIR}" -name '*.yml' 2>/dev/null | sort)

  sel_layout=$(
    printf '%s' "${layouts}" \
      | fzf --prompt="  2/3 layout > " \
             --layout=reverse --border=none --no-separator \
             --color="${_fzf_colors}" \
             --header="2/3 layout â”‚ ESC back" \
             --preview="
               item={}
               if [[ \"\$item\" == '(auto)'* ]]; then
                 echo -e '\033[1;35mâš¡ Auto-detect\033[0m'
                 echo 'Matches layout by directory name, falls back to default.yml'
                 echo ''
                 match=\"${LAYOUT_DIR}/${default_name}.yml\"
                 if [[ -f \"\$match\" ]]; then
                   echo -e '\033[1;32mâœ“ Found: ${default_name}.yml\033[0m'
                   echo -e '\033[90m$(printf '%.0sâ”€' {1..40})\033[0m'
                   cat \"\$match\"
                 else
                   echo -e '\033[1;33mâ—‹ No match â†’ default.yml\033[0m'
                   echo -e '\033[90m$(printf '%.0sâ”€' {1..40})\033[0m'
                   cat '${LAYOUT_DIR}/default.yml' 2>/dev/null || echo '(no default layout)'
                 fi
               else
                 yml='${LAYOUT_DIR}/'\"\$item\".yml
                 echo -e \"\033[1;35mğŸ“‹ \$item\033[0m\"
                 echo -e '\033[90m$(printf '%.0sâ”€' {1..40})\033[0m'
                 cat \"\$yml\" 2>/dev/null || echo '(file not found)'
               fi
             " --preview-window="${_preview_pos}"
  ) || return 1
  sel_layout="${sel_layout%% *}"  # strip description from (auto) line

  # Step 3: Session name (editable, default = dir basename)
  sel_name=$(
    echo "${default_name}" \
      | fzf --prompt="  3/3 name > " \
             --layout=reverse --border=none --no-separator \
             --color="${_fzf_colors}" \
             --header="3/3 name â”‚ ESC back" \
             --print-query --select-1 \
             --preview="
               echo -e '\033[1;36mğŸ“Œ Session Summary\033[0m'
               echo -e '\033[90m$(printf '%.0sâ”€' {1..40})\033[0m'
               echo -e '\033[37m  Dir:    ${sel_dir}\033[0m'
               echo -e '\033[37m  Layout: ${sel_layout}\033[0m'
               echo -e '\033[37m  Name:   '\"{}\"\033[0m
             " --preview-window="${_preview_pos}"
  ) || return 1
  # --print-query outputs query on first line, selected on second
  sel_name=$(echo "${sel_name}" | head -1)
  sel_name="${sel_name:-$default_name}"

  # Check if session already exists
  if tmux has-session -t="${sel_name}" 2>/dev/null; then
    echo "Session '${sel_name}' already exists â€” switching." >&2
    _do_switch "${sel_name}"
    return 0
  fi

  # Create session
  tmux new-session -ds "${sel_name}" -c "${sel_dir}"

  # Apply layout
  if [[ "${sel_layout}" == "(auto)" ]]; then
    ~/.tmux/bin/tmux-layout-apply "${sel_name}" "${sel_dir}"
  else
    local yml_path="${LAYOUT_DIR}/${sel_layout}.yml"
    if [[ -f "${yml_path}" ]]; then
      ~/.tmux/bin/tmux-layout-apply "${sel_name}" "${sel_dir}" "${yml_path}"
    fi
  fi

  # Sidebar init
  ~/.tmux/bin/tmux-sidebar-init "${sel_name}" &

  _do_switch "${sel_name}"
}

# â”€â”€â”€ Switch helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_do_switch() {
  local target="$1"
  if [[ -z "${TMUX:-}" ]]; then
    exec tmux attach-session -t "${target}"
  else
    tmux switch-client -t "${target}"
  fi
}

# â”€â”€â”€ Main Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ $# -eq 1 ]]; then
  selected="$1"
else
  # Build items: create option + active sessions + ~/dev dirs
  active_sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null || true)
  items="â• Create New Session"$'\n'

  # Active sessions (marked â—)
  while IFS= read -r s; do
    [[ -z "$s" ]] && continue
    items+="â— ${s}"$'\n'
  done <<< "${active_sessions}"

  # ~/dev directories (skip if session already exists)
  while IFS= read -r dir; do
    name=$(basename "$dir" | tr ' .:' '_')
    if ! echo "${active_sessions}" | grep -qx "${name}"; then
      items+="  ${dir}"$'\n'
    fi
  done < <(find "${SCAN_DIR}" -mindepth 1 -maxdepth 1 -type d | sort)

  # Extra directories (e.g. ~/.config/opencode)
  for dir in "${EXTRA_DIRS[@]}"; do
    [[ -d "$dir" ]] || continue
    name=$(basename "$dir" | tr ' .:' '_')
    if ! echo "${active_sessions}" | grep -qx "${name}"; then
      items+="  ${dir}"$'\n'
    fi
  done

  selected=$(
    printf '%s' "${items}" \
      | fzf --prompt="  switch > " \
             --layout=reverse --border=none --no-separator \
             --color="${_fzf_colors}" \
              --header="â— active â”‚ â• create â”‚ ^R rename" \
              --bind 'ctrl-r:execute(~/.tmux/bin/tmux-session-rename {})+become(~/.tmux/bin/tmux-sessionizer)' \
             --bind "focus:execute-silent(echo {} | grep -q '^â— ' && tmux switch-client -t \"\$(echo {} | sed 's/^â— //')\" 2>/dev/null || true)" \
             --preview='
                item={}
                if [[ "$item" == "â•"* ]]; then
                  echo -e "\033[1;35mâ• New Session\033[0m"
                  echo -e "\033[37mdir â†’ layout â†’ name\033[0m"
                 elif [[ "$item" == "â— "* ]]; then
                   name="${item#â— }"
                   created=$(tmux display-message -t "$name" -p "#{t:session_created}" 2>/dev/null)
                   mapfile -t windows < <(tmux list-windows -t "$name" -F "#{window_index}:#{window_name}:#{window_active}:#{window_panes}" 2>/dev/null)
                   nwin=${#windows[@]}
                   win_summary=""
                   for w in "${windows[@]}"; do
                     IFS=: read -r wi wn wa wp <<< "$w"
                     if [[ "$wa" == "1" ]]; then
                       win_summary+=" \033[1;7;34m ${wn}(${wp}) \033[0m"
                     else
                       win_summary+=" \033[90m${wn}(${wp})\033[0m"
                     fi
                   done
                   echo -e "\033[1;32mâ— ${name}\033[0m ${win_summary} \033[90m ${created}\033[0m"
                   echo ""
                   for w in "${windows[@]}"; do
                     IFS=: read -r wi wn wa wp <<< "$w"
                     if [[ "$nwin" -gt 1 ]]; then
                       if [[ "$wa" == "1" ]]; then
                         echo -e "\033[1;34mâ–¸ ${wn}\033[0m \033[90m(${wp} panes)\033[0m"
                       else
                         echo -e "\033[90m  ${wn}\033[0m \033[90m(${wp} panes)\033[0m"
                       fi
                     fi
                     mapfile -t panes < <(tmux list-panes -t "$name:${wi}" -F "#{pane_index}" 2>/dev/null)
                     lines_per_pane=$(( (LINES - 6) / (${#panes[@]} * nwin + 1) ))
                     [[ "$lines_per_pane" -lt 5 ]] && lines_per_pane=5
                     [[ "$lines_per_pane" -gt 20 ]] && lines_per_pane=20
                     if [[ "${#panes[@]}" -le 1 ]]; then
                       tmux capture-pane -t "$name:${wi}" -p -e 2>/dev/null | tail -${lines_per_pane}
                     else
                       for pane in "${panes[@]}"; do
                         [[ -z "$pane" ]] && continue
                         echo -e "\033[38;2;86;95;137mâ”€â”€â”€ pane ${pane} â”€â”€â”€\033[0m"
                         tmux capture-pane -t "$name:${wi}.${pane}" -p -e 2>/dev/null | tail -${lines_per_pane}
                       done
                     fi
                     [[ "$nwin" -gt 1 ]] && echo ""
                   done
                else
                  dir="${item#  }"
                  echo -e "\033[1;33mâ—‹ new session\033[0m  ($(basename "$dir" | tr " .:" "_"))"
                  ls -1 --color=always "$dir" 2>/dev/null | head -30
                fi
              ' --preview-window="${_preview_pos}"
  ) || { tmux switch-client -t "${_orig_session}" 2>/dev/null; exit 0; }
fi

# â”€â”€â”€ Handle selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${selected}" == "â•"* ]]; then
  create_session_wizard || { tmux switch-client -t "${_orig_session}" 2>/dev/null; exit 0; }
elif [[ "${selected}" == "â— "* ]]; then
  session_name="${selected#â— }"
  _do_switch "${session_name}"
else
  selected="${selected#  }"  # strip leading spaces
  session_name=$(basename "${selected}" | tr ' .:' '_')

  if ! tmux has-session -t="${session_name}" 2>/dev/null; then
    tmux new-session -ds "${session_name}" -c "${selected}"
    ~/.tmux/bin/tmux-layout-apply "${session_name}" "${selected}"
    ~/.tmux/bin/tmux-sidebar-init "${session_name}" &
  fi
  _do_switch "${session_name}"
fi
