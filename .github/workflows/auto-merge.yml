# Auto-merge for Dependabot, owner, and Codex PRs
# SSoT: qws941/.github — synced to all repos (except terraform)
# Synced via: .github/sync.yml → Group 2
#
# Triggers:
#   - Dependabot PRs (auto-merge with squash)
#   - Repository owner PRs (auto-merge with squash)
#   - PRs with 'auto-merge' label
#   - Codex PRs (by 'codex' label or bot author)

name: Auto Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >-
      github.actor == 'dependabot[bot]' ||
      github.actor == github.repository_owner ||
      contains(github.event.pull_request.labels.*.name, 'auto-merge') ||
      contains(github.event.pull_request.labels.*.name, 'codex')
    steps:
      - name: Check Codex PR
        id: codex
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          AUTHOR=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
            --json author --jq '.author.login')
          # Codex bot login is 'Codex' (type: Bot), not '[bot]' suffix
          if [ "$AUTHOR" = "Codex" ]; then
            echo "codex=true" >> "$GITHUB_OUTPUT"
          else
            echo "codex=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --squash \
            --auto || echo "Auto-merge already enabled or not mergeable"
