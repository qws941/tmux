# Auto-merge for Dependabot, owner, sync, and Codex PRs
# SSoT: qws941/.github — synced to all repos (except terraform)
# Synced via: .github/sync.yml → Group 2
#
# Triggers:
#   - Dependabot PRs (auto-merge with squash)
#   - Repository owner PRs (auto-merge with squash)
#   - PRs with 'auto-merge', 'sync', or 'codex' label
#
# Merge strategy: GH_PAT with admin bypass via repository rulesets
# No approval step needed — admin role bypasses required reviews

name: Auto Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >-
      github.actor == 'dependabot[bot]' ||
      github.actor == github.repository_owner ||
      contains(github.event.pull_request.labels.*.name, 'auto-merge') ||
      contains(github.event.pull_request.labels.*.name, 'codex') ||
      contains(github.event.pull_request.labels.*.name, 'sync')
    steps:
      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::GH_PAT secret is not set — see qws941/.github README"
            exit 1
          fi
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --squash \
            --auto
