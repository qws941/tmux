#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/oc/config.sh"
source "$SCRIPT_DIR/lib/oc/helpers.sh"
source "$SCRIPT_DIR/lib/oc/commands.sh"

main() {
    local cmd="${1:-}"
    local env="${2:-}"

    case "$cmd" in
        start|stop|restart|rotate-logs)
            if [[ "$env" == "all" || -z "$env" ]]; then
                for e in "${ENVS[@]}"; do
                    if [[ "$cmd" == "rotate-logs" ]]; then
                        cmd_logs_rotate "$e"
                    else
                        "cmd_$cmd" "$e"
                    fi
                done
            else
                validate_env "$env"
                if [[ "$cmd" == "rotate-logs" ]]; then
                    cmd_logs_rotate "$env"
                else
                    "cmd_$cmd" "$env"
                fi
            fi
            ;;
        status)
            cmd_status
            ;;
        health)
            cmd_health
            ;;
        logs)
            [[ -z "$env" ]] && { echo -e "${RED}Error:${NC} Specify env: oc logs <co|claude|anti>"; exit 1; }
            validate_env "$env"
            cmd_logs "$env"
            ;;
        switch)
            [[ -z "$env" ]] && { echo -e "${RED}Error:${NC} Specify env: oc switch <co|claude|anti>"; exit 1; }
            validate_env "$env"
            cmd_switch "$env"
            ;;
        -h|--help|help|"")
            usage
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown command '$cmd'"
            usage
            exit 1
            ;;
    esac
}

main "$@"
